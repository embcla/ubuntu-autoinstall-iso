#cloud-config
autoinstall:
  version: 1
#  user-data:
#    - name: claudio
#      groups: users, admin
#      sudo: ALL=(ALL) NOPASSWD:ALL
#      shell: /bin/bash

  early-commands:
    # These run before network config, using packages from ISO
    - ['apt-get', 'update']
    - ['apt-get', 'install', '-y', 'iw', 'wpasupplicant', 'wireless-tools']

  packages:
    - fail2ban
    - ufw
    - iw
    - wireless-tools
    - wpasupplicant

  apt:
    update: true
    upgrade: true


  locale: en_US.UTF-8
  keyboard:
    layout: it
  source:
    id: ubuntu-server-minimal


  network:
    version: 2
    ethernets:
      enp0s31f6:
        dhcp4: true
    wifis:
      wlp2s0:
        regulatory-domain: "IT"
        optional: true
        dhcp4: true
        access-points:
          "SSID":
            auth:
              key-management: "psk"
              password: "passwd"

  identity:
    username: user
    hostname: hostname
    password: "passwd-hash"
    groups: [sudo, adm]

  ssh:
    install-server: true
    allow-pw: false
    authorized-keys:
      - "ssh-ed25519 hash"
      - "ssh-rsa hash"
    disable-root: true
    disable_root_opts: no-port-forwarding,no-agent-forwarding,no-X11-forwarding

  timezone: Europe/Amsterdam
  late-commands:
    # Add user to sudoers
#    - ['usermod', '-a', '-G', 'admin', 'user']
#    - ['usermod', '-s', '/bin/bash', 'user']
    # One-command install, from https://tailscale.com/download/
    - ['sh', '-c', 'curl -fsSL https://tailscale.com/install.sh | sh']
    # Set sysctl settings for IP forwarding (useful when configuring an exit node)
    - ['sh', '-c', "echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.d/99-tailscale.conf && echo 'net.ipv6.conf.all.forwarding = 1' | sudo tee -a /etc/sysctl.d/99-tailscale.conf && sudo sysctl -p /etc/sysctl.d/99-tailscale.conf"]
    # Generate an auth key from your Admin console
    # https://login.tailscale.com/admin/settings/keys
    # and replace the placeholder below
    - ['tailscale', 'up', 'tskey-auth-hash']
    # (Optional) Include this line to make this node available over Tailscale SSH
    - ['tailscale', 'set', '--ssh --accept-dns']
    # (Optional) Include this line to configure this machine as an exit node
    - ['tailscale', 'set', '--advertise-exit-node']
  shutdown:
    reboot
