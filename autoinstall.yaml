---
#cloud-config
autoinstall:
  version: 1
  user-data:
    - name: claudio
      groups: users, admin
      sudo: ALL=(ALL) NOPASSWD:ALL
      shell: /bin/bash

  packages:
    - fail2ban
    - ufw

  apt:
    update: true
    upgrade: true


  locale: en_US.UTF-8
  keyboard:
    layout: it
  source:
    id: ubuntu-server-minimal


  network:
    version: 2
    ethernets:
      eth0:
        dhcp4: true
    wifis:
      wlan0:
        regulatory-domain: "IT"
        optional: true
        dhcp4: true
        access-points:
          "Casa Carbocca":
            auth:
              key-management: "psk"
              password: "ssid-password"

  identity:
    username: user
    hostname: linux-autoinstall
    password: "hash"

  ssh:
    install-server: true
    allow-pw: false
    authorized-keys:
      - "ssh-ed25519 hash"
      - "ssh-rsa hash"
    disable-root: true
    disable_root_opts: no-port-forwarding,no-agent-forwarding,no-X11-forwarding

  timezone: Europe/Amsterdam
  late-commands:
    # One-command install, from https://tailscale.com/download/
    - ['sh', '-c', 'curl -fsSL https://tailscale.com/install.sh | sh']
    # Set sysctl settings for IP forwarding (useful when configuring an exit node)
    - ['sh', '-c', "echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.d/99-tailscale.conf && echo 'net.ipv6.conf.all.forwarding = 1' | sudo tee -a /etc/sysctl.d/99-tailscale.conf && sudo sysctl -p /etc/sysctl.d/99-tailscale.conf"]
    # Generate an auth key from your Admin console
    # https://login.tailscale.com/admin/settings/keys
    # and replace the placeholder below
    - ['tailscale', 'up', 'tskey-auth-hash']
    # (Optional) Include this line to make this node available over Tailscale SSH
    - ['tailscale', 'set', '--ssh --accept-dns']
    # (Optional) Include this line to configure this machine as an exit node
    - ['tailscale', 'set', '--advertise-exit-node']
  shutdown:
    reboot
